---
title: "Data_Analysis"
author: "Rienk Heins"
date: "3/3/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(flowCore)
library(ggcyto)
library(ggpubr)
library(Biobase)
library(ggplot2)
```

# Loading the data

Dataset 1:

```{r}
file_list1 <- list.files(path="../FACS_Data/PHBV_Micha1/")
dataset1 <- data.frame()
for(i in 1:length(file_list1)){
  file_string <- file_list1[i]
  file_string <- paste("../FACS_Data/PHBV_Micha1/", file_string, sep = "")
  fcs.data <- read.FCS(file_string)
  fcs.data.frame <- as.data.frame(exprs(fcs.data)) 
  dataset1 <- rbind(dataset1, fcs.data.frame)
}
head(dataset1)
summary(dataset1)
```

Dataset 2:

```{r}
file_list2 <- list.files(path="../FACS_Data/PHBV_Micha2/")
dataset2 <- data.frame()
for(i in 1:length(file_list2)){
  file_string <- file_list2[i]
  file_string <- paste("../FACS_Data/PHBV_Micha2/", file_string, sep = "")
  fcs.data <- read.FCS(file_string)
  fcs.data.frame <- as.data.frame(exprs(fcs.data)) 
  dataset2 <- rbind(dataset2, fcs.data.frame)
}
head(dataset2)
summary(dataset2)
```

Dataset 3:

```{r}
file_list3 <- list.files(path="../FACS_Data/PHBV_Micha3/")
dataset3 <- data.frame()
for(i in 1:length(file_list3)){
  file_string <- file_list3[i]
  file_string <- paste("../FACS_Data/PHBV_Micha3/", file_string, sep = "")
  fcs.data <- read.FCS(file_string)
  fcs.data.frame <- as.data.frame(exprs(fcs.data)) 
  dataset3 <- rbind(dataset3, fcs.data.frame)
}
head(dataset3)
summary(dataset3)
```

Dataset 4:

```{r}
file_list4 <- list.files(path="../FACS_Data/PHBV_Micha4/")
dataset4 <- data.frame()
for(i in 1:length(file_list4)){
  file_string <- file_list4[i]
  file_string <- paste("../FACS_Data/PHBV_Micha4/", file_string, sep = "")
  fcs.data <- read.FCS(file_string)
  fcs.data.frame <- as.data.frame(exprs(fcs.data)) 
  dataset4 <- rbind(dataset4, fcs.data.frame)
}
head(dataset4)
summary(dataset4)
```

# Visualtization

For the first steps of the analysis hierarchical clusters will be made to figure out how many clusters exist in the datasets, as each of these clusters could represent a plastic or a bacteria specie. 

```{r}
par(mfrow=c(2,2))
plot(dataset1$`FSC-H` ~ dataset1$`SSC-H`)
plot(dataset2$`FSC-H` ~ dataset2$`SSC-H`)
plot(dataset3$`FSC-H` ~ dataset3$`SSC-H`)
plot(dataset4$`FSC-H` ~ dataset4$`SSC-H`)
```

## Clustering

Cluster data plotted using height scatter.

```{r}
par(mfrow=c(2,2))
km1 <- kmeans(dataset1[,c(1:12)], 2)
km2 <- kmeans(dataset2[,c(1:12)], 2)
km3 <- kmeans(dataset3[,c(1:12)], 2)
km4 <- kmeans(dataset4[,c(1:12)], 2)
ggplot() + geom_point(data = dataset1, mapping = aes(x = `FSC-H`, y = `SSC-H`, colour = km1$cluster)) +
  geom_point(mapping = aes(x = km1$centers[,7], y = km1$centers[,8]), color = "red", size = 4) +
  ggtitle("Cluster of microbial and plastic flow cytometry data visualized on foward vs sideward height scattering from dataset 1") +
  xlab("Forward scatter H") + ylab("Sideward scatter H")

ggplot() + geom_point(data = dataset2, mapping = aes(x = `FSC-H`, y = `SSC-H`, colour = km2$cluster)) +
  geom_point(mapping = aes(x = km2$centers[,7], y = km2$centers[,8]), color = "red", size = 4) +
  ggtitle("Cluster of microbial and plastic flow cytometry data visualized on foward vs sideward height scattering from dataset 2") +
  xlab("Forward scatter H") + ylab("Sideward scatter H")

ggplot() + geom_point(data = dataset3, mapping = aes(x = `FSC-H`, y = `SSC-H`, colour = km3$cluster)) +
  geom_point(mapping = aes(x = km3$centers[,7], y = km3$centers[,8]), color = "red", size = 4) +
  ggtitle("Cluster of microbial and plastic flow cytometry data visualized on foward vs sideward height scattering from dataset 3") +
  xlab("Forward scatter H") + ylab("Sideward scatter H")

ggplot() + geom_point(data = dataset4, mapping = aes(x = `FSC-H`, y = `SSC-H`, colour = km4$cluster)) +
  geom_point(mapping = aes(x = km4$centers[,7], y = km4$centers[,8]), color = "red", size = 4) +
  ggtitle("Cluster of microbial and plastic flow cytometry data visualized on foward vs sideward height scattering from dataset 4") +
  xlab("Forward scatter H") + ylab("Sideward scatter H")
```

Cluster data using area scatter.

```{r}
par(mfrow=c(2,2))
ggplot() + geom_point(data = dataset1, mapping = aes(x = `FSC-A`, y = `SSC-A`, colour = km1$cluster)) +
  geom_point(mapping = aes(x = km1$centers[,1], y = km1$centers[,2]), color = "red", size = 4) +
  ggtitle("Cluster of microbial and plastic flow cytometry data visualized on foward vs sideward area scattering from dataset 1") +
  xlab("Forward scatter A") + ylab("Sideward scatter A")

ggplot() + geom_point(data = dataset2, mapping = aes(x = `FSC-A`, y = `SSC-A`, colour = km2$cluster)) +
  geom_point(mapping = aes(x = km2$centers[,1], y = km2$centers[,2]), color = "red", size = 4) +
  ggtitle("Cluster of microbial and plastic flow cytometry data visualized on foward vs sideward area scattering from dataset 2") +
  xlab("Forward scatter A") + ylab("Sideward scatter A")

ggplot() + geom_point(data = dataset3, mapping = aes(x = `FSC-A`, y = `SSC-A`, colour = km3$cluster)) +
  geom_point(mapping = aes(x = km3$centers[,1], y = km3$centers[,2]), color = "red", size = 4) +
  ggtitle("Cluster of microbial and plastic flow cytometry data visualized on foward vs sideward area scattering from dataset 3") +
  xlab("Forward scatter A") + ylab("Sideward scatter A")

ggplot() + geom_point(data = dataset4, mapping = aes(x = `FSC-A`, y = `SSC-A`, colour = km4$cluster)) +
  geom_point(mapping = aes(x = km4$centers[,1], y = km4$centers[,2]), color = "red", size = 4) +
  ggtitle("Cluster of microbial and plastic flow cytometry data visualized on foward vs sideward area scattering from dataset 4") +
  xlab("Forward scatter A") + ylab("Sideward scatter A")
```

As seen in the figures above the clusters are mostly separated by an increase in scattering, with the first cluster sitting in the bottom left of the plot while the second cluster starts forming after a sideward scatter of just before 5.0e+06 with the exception of the second dataset. A higher forward scatter also seems to resemble the second cluster but seems to be less important than the difference in sideward scatter. 

To determine which cluster specifies which group the types of scatters have to be known. According to the fcs documentation forward scatter describes the size of the particle and sideward the complexity of the particle. Knowing this it can be assumed that the black cluster are the plastics and the red cluster the microbes as the microbes have a more complex surface with structures on their cell walls while the plastics should be relatively simple and the same form, meaning that they are centered more on the left of the plot.

Creating of csv files:

```{r}
write.csv(dataset1, file = "./CSVdata/dataset1.csv", row.names = FALSE)
write.csv(dataset2, file = "./CSVdata/dataset2.csv", row.names = FALSE)
write.csv(dataset3, file = "./CSVdata/dataset3.csv", row.names = FALSE)
write.csv(dataset4, file = "./CSVdata/dataset4.csv", row.names = FALSE)
```


