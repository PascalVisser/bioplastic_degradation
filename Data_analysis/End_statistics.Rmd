---
title: "End statistics"
author: "Rienk Heins"
date: '2022-05-31'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dbscan)
library(ggplot2)
```



# Make dbscan function
```{r}
db_clustering <- function(file_in, NumOfPts = 20){
  modified <- file_in[1:2]
  

  modified[modified == 0] <- NA
  
  for(i in 1:ncol(modified)){
    modified[is.na(modified[,i]), i] <- mean(modified[,i], na.rm = TRUE)
  }
  
  log_file <- log2(modified)
  
  scan <- hdbscan(x = log_file, minPts = NumOfPts, gen_hdbscan_tree = T, gen_simplified_tree = F)
  plot(log_file, col = scan$cluster +1, pch = 20)
  return(scan)
}

points_calc <- function(x){
  num_of_points <- length(x[,1])/100*1.5
  return(num_of_points)}

```


# Execute
```{r}
sample1 <- read.csv("../csvData/csvData3/Sample1/A01_Uncolored_PHBV_Before_freeze_thaw_Dilution10x_Sample01.fcs.csv")
sample2 <- read.csv("../csvData/csvData3/Sample1/A05_Uncolored_PHBV_After_freeze_thaw_Dilution10x_Sample01.fcs.csv")
sample3 <- read.csv("../csvData/Sample1_folder1.csv")

db1 <- db_clustering(sample1, points_calc(sample1))
db2 <- db_clustering(sample3, points_calc(sample2))
```

```{r}
sample1 <- cbind(sample1, db1$cluster)
sample1$`db1$cluster`
plot(y = log2(sample1$SSC.A), x = log2(sample1$FSC.A), col = sample1$`db1$cluster`)
legend(1, 95, col = sample1$`db1$cluster`, legend = "legend", lty=1:2, cex=0.8)
```

```{r}
sample2 <- cbind(sample2, db2$cluster)
```


```{r}
plot(x = log2(sample1[sample1$`db1$cluster` == 2, 'FSC.A']),y = log2(sample1[sample1$`db1$cluster` == 2, 'SSC.A']))
```


```{r}
mean(sample1[sample1$`db1$cluster` == 2, 'FSC.A'])
mean(sample1[sample1$`db1$cluster` == 2, 'FSC.H'])
mean(sample1[sample1$`db1$cluster` == 2, 'Width'])
```

# Create functions for statistics

```{r}
perc_shift <- function(x, y){
  return(((y-x)/x) * 100)
}

cluster_vector <- function(x, y){
  return(c(x[1] - y[1], x[2] - y[2]))
}
```

