---
title: "library"
author: "Pascal Visser"
date: '2022-06-07'
output: html_document
---


# Load packages

install the packages if not installed, otherwise load them 

```{r}
library(dbscan)
library(sys)
library(dplyr)
```




# Dbscan function
```{r}
db_clustering <- function(file_in, NumOfPts = 20){
  
  gc()
  
  # Random samples data if file to big  
    if (between(nrow(file_in), 10000, 20000)){
    file_in <- sample_n(file_in, 15000, replace = T)
    memory.limit(size = 16000)
  } else if (nrow(file_in) > 20000){
    file_in <- sample_n(file_in, 28000)
    memory.limit(size = 16000)
  }
  
  # strip all columns except fsc and ssc
  modified <- file_in[,c(1,2)]
  

  # if there are NA's, replaces them with the mean
  modified[modified == 0] <- NA
  
  for(i in 1:ncol(modified)){
    modified[is.na(modified[,i]), i] <- mean(modified[,i], na.rm = TRUE)
  }
  
  # log transform file
  log_file <- log2(modified)
  
  # Apply Hdbscan on log transformed data
  scan <- hdbscan(log_file, NumOfPts)
  
  # plots the data and return scan statistics
  plot(log_file, col = scan$cluster +1, pch = 20)
  return(scan)
}

points_calc <- function(x){
  
  # calculate number of points with 1.5%
  num_of_points <- length(x[,1])/100*1.5
  
  # if data is small, apply smaller number of points
  if (length(row(x[1])) > 20000){
    num_of_points <- 25000/100*0.55}
  else if (length(row(x[1])) < 1000){
    num_of_points <- 15}
  else {
  }
  
  return(num_of_points)
}

```


```{r}
# assign

map1 <- read.csv("../all_map/map1.csv")
map2 <- read.csv("../all_map/map2.csv")
map3 <- read.csv("../all_map/map3.csv")
map4 <- read.csv("../all_map/map4.csv")
```

# Execute
```{r}
gc()
start_time <- Sys.time()

db_clustering(map1, points_calc(map1))
db_clustering(map2, points_calc(map2))
db_clustering(map3, points_calc(map3))
db_clustering(map4, points_calc(map4))

end_time <- Sys.time()

cat("\nRunning time = ", round(end_time - start_time, 2), "Seconds")
```

Running time sample 1 map 1

10.000 = 7.874149 Seconds
20.000 = 17.71293 Seconds
25.000 = 31.21267 Seconds
30.000 = 59.7622 Seconds


